<!-- Copyright (c) 2016-2017, Randy Westlund. All rights reserved. -->
<!-- This code is under the BSD-2-Clause license. -->

<!-- This module displays a responsive dialog that is fullscreen on mobile and
     a normal paper-dialog on desktop, in accordance with Google's Material
     Design guidelines.  -->

<link rel="import" href="../app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../app-layout/app-header/app-header.html">
<link rel="import" href="../app-layout/app-scroll-effects/effects/waterfall.html">
<link rel="import" href="../app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../polymer/lib/elements/dom-if.html">
<link rel="import" href="../polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../polymer/polymer-element.html">

<dom-module id="responsive-dialog-ns">
    <template>
        <style>
            :host {
                display: none;
            }
            :host([opened]) {
                display: block;
            }
            :host([mobile]) {
                position:   fixed;
                left:       0;
                right:      0;
                top:        0;
                bottom:     0;
                z-index:    103;
                background-color: var(--primary-background-color);
            }
            div.fullscreen-column {
                padding-left:   1em;
                padding-right:  1em;
                padding-bottom: 2em;
            }
            [hidden] {
                display: none;
            }
            app-toolbar {
                @apply --responsive-dialog-toolbar;
            }
            paper-dialog {
                min-width: 25em;
                @apply --responsive-dialog-paper-dialog;
            }
        </style>

        <!-- Determine which layout to use. -->
        <iron-media-query query="(max-width: [[responsiveWidth]])"
                query-matches="{{mobile}}">
        </iron-media-query>

        <!-- This normal paper-dialog is used on desktop. -->
        <paper-dialog id="dialog" with-backdrop no-cancel-on-outside-click
                on-iron-overlay-closed="_prevent_bubble_hack">
            <h2>[[title]]</h2>
            <div id="desktop_slot">
                <!-- Light DOM goes here. -->
            </div>
            <div class="buttons">
                <template is="dom-if" if="[[dismissText]]">
                    <paper-button dialog-dismiss>[[dismissText]]</paper-button>
                </template>
                <template is="dom-if" if="[[confirmText]]">
                    <paper-button dialog-confirm>[[confirmText]]</paper-button>
                </template>
            </div>
        </paper-dialog>

        <!-- This custom fullscreen dialog is used on mobile. -->
        <app-header-layout id="header_layout"
                has-scrolling-region
                fullbleed
                hidden$="[[!mobile]]">
            <app-header slot="header" fixed effects="waterfall">
                <app-toolbar>
                    <paper-icon-button
                            icon="[[get_icon(dismissText)]]"
                            on-tap="dismiss">
                    </paper-icon-button>
                    <div main-title>[[title]]</div>
                    <!-- If there's no dismissText, then we're just showing a
                         back arrow. -->
                    <template is="dom-if" if="[[dismissText]]">
                        <paper-button on-tap="confirm">
                            [[confirmText]]
                        </paper-button>
                    </template>
                </app-toolbar>
            </app-header>

            <div id="mobile_slot" class="fullscreen-column"
                    on-iron-overlay-closed="_prevent_bubble_hack">
                <!-- Light DOM goes here. -->
                <!-- This light DOM will be moved to the correct place. -->
                <slot id="slot"></slot>
            </div>
        </app-header-layout>

        <!-- TODO this dialog should capture and close on a mobile device's
             back arrow. -->
    </template>
</dom-module>

<script>
"use strict";
class ResponsiveDialogNS extends Polymer.GestureEventListeners(Polymer.Element) {
    static get is() { return "responsive-dialog-ns"; }
    static get properties() {
        return {
            // Anything smaller than this is mobile.
            responsiveWidth: { type: String, value: "600px" },
            // The h2 title of the dialog.
            title: { type: String },
            // What text to use for the dismiss button. If not defined, no
            // dismiss button will be shown. On mobile, defining this
            // causes an X rather than a back arrow.
            dismissText: { type: String, value: "" },
            // What text to use for the confirm button.
            confirmText: { type: String, value: "Save" },
            // Whether we're on mobile or desktop. Determined with a media
            // query.
            mobile: { type: Boolean, value: true, reflectToAttribute: true },
            opened: { type: Boolean, value: false, reflectToAttribute: true },
            domIsMobile: { type: Boolean, value: true },
        };
    }
    static get observers() {
        return [ "move_dom(mobile, opened)" ];
    }
    // When we change layouts, move the light DOM to the right place
    // and open or close the paper-dialog as necessary.
    move_dom(mobile, opened) {
        if (!opened) return;
        if (this.mobile) {
            this.$.dialog.close();
            if (!this.domIsMobile) {
                Polymer.dom(this.$.mobile_slot).appendChild(this.$.slot);
                this.domIsMobile = true;
            }
            this.$.header_layout.resetLayout();
        } else {
            if (this.domIsMobile) {
                Polymer.dom(this.$.desktop_slot).appendChild(this.$.slot);
                this.domIsMobile = false;
            }
            this.$.dialog.open();
        }
    }
    // HACK: The paper-dropdown-menu element implements
    // iron-overlay-behavior, which means that is fires
    // iron-overlay-closed, which bubbles all the way up here. On
    // desktop, it would close this dialog. On mobile, it would keep
    // causing havoc in parent elements. This should be fixed in a
    // future version of Polymer. See:
    // https://github.com/PolymerElements/iron-overlay-behavior/issues/70
    // https://github.com/PolymerElements/paper-dropdown-menu/issues/87
    _prevent_bubble_hack(e, reason) {
        // Shadow DOM's event retargeting means that this.fire() and
        // closing the dialog both have e.target === this. The event
        // from a dropdown in the light DOM does not.
        if (e.target === this.$.dialog && !(this.mobile && this.opened))
            this.opened = false;
        // Otherwise it must be from the light DOM or we're just moving
        // to mobile. Stop it here.
        else e.stopImmediatePropagation();
    }
    open() { this.opened = true; }
    close() {
        this.opened = false;
        if (!this.mobile) this.$.dialog.close();
        else this.dismiss();
    }
    notifyResize() { if (!this.mobile) this.$.dialog.notifyResize(); }
    // Only used on mobile.
    dismiss(e) {
        //TODO this tap still highlights the menu icon behind it :/
        e.stopPropagation();
        this.opened = false;
        this.fire('iron-overlay-closed', { canceled: true });
    }
    // Only used on mobile.
    confirm() {
        this.opened = false;
        this.fire('iron-overlay-closed', { confirmed: true });
    }
    // If no dismissText, use <- rather than X.
    get_icon(dt) { return dt ? "icons:close" : "icons:arrow-back"; }
}
customElements.define(ResponsiveDialogNS.is, ResponsiveDialogNS);
</script>
